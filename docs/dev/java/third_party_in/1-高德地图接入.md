# é«˜å¾·åœ°å›¾æ¥å…¥

## æœåŠ¡æ¦‚è¿°

ä½¿ç”¨é«˜å¾· Web API æœåŠ¡ï¼Œé‰´æƒæ–¹å¼æ˜¯ï¼šåœ¨è¯·æ±‚å‚æ•°ä¸­åŠ å…¥ key å’Œç­¾å(è‹¥éœ€è¦)ã€‚

## æ¥å…¥æµç¨‹

`org.springframework.boot.autoconfigure.AutoConfiguration.imports`ğŸ‘‰`MapAutoConfiguration.java`ğŸ‘‰`GaodeMapProperties.java`ğŸ‘‰`GeocodeApi.java`ğŸ‘‰`GaodeApiConfiguration.java`ğŸ‘‰`GaodeApiRequestInterceptor.java`
æ–°åˆ›å»ºä¸€ä¸ªæ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—æ²¡æœ‰å¯åŠ¨ç±»ã€‚
![image.png](/images/dev/java/third_party_in/gaode.png)
`META-INF/spring`ç›®å½•ä¸‹çš„`org.springframework.boot.autoconfigure.AutoConfiguration.imports`æ–‡ä»¶å¯ä»¥æŒ‡å®šè¦å¯¼å…¥çš„è‡ªåŠ¨é…ç½®ç±»ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œè¯¥æ–‡ä»¶æŒ‡å®šï¼šå°†`com.deye.ems.cloud.common.map.MapAutoConfiguration`å¯¼å…¥ä¸ºè‡ªåŠ¨é…ç½®ç±»ï¼Œå½“æœ‰å¯åŠ¨ç±»çš„æ¨¡å—å¼•å…¥æ­¤æ¨¡å—ï¼Œ`com.deye.ems.cloud.common.map.MapAutoConfiguration`å°†æˆä¸ºè‡ªåŠ¨é…ç½®ç±»ã€‚

```java
com.deye.ems.cloud.common.map.MapAutoConfiguration
```

`**MapAutoConfiguration**`**é…ç½®ç±»ç­‰åŒäºè¯¥æ¨¡å—çš„å¯åŠ¨ç±»ã€‚**

```java
@EnableConfigurationProperties(GaodeMapProperties.class)
@ComponentScan(basePackages = "com.deye.ems.cloud.common.map.api")
public class MapAutoConfiguration {

}
```

`@EnableConfigurationProperties`æ³¨è§£å¯ä»¥å°†é…ç½®æ–‡ä»¶`application.yml`ä¸­çš„å±æ€§æ³¨å…¥åˆ°æŒ‡å®šçš„ç±»ï¼Œæˆä¸ºä¸€ä¸ª beanã€‚

```java
@Data
@ConfigurationProperties(prefix = "map.gaode")
public class GaodeMapProperties {
    private String url;
    private String key;
    private String secret;
}
```

`@ConfigurationProperties(prefix = "map.gaode")`å¯ä»¥å°†é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§è¿›è¡Œæ³¨å…¥ï¼Œå¹¶æŒ‡å®šå‰ç¼€ã€‚`**GaodeMapProperties**`**çš„å­˜åœ¨æ˜¯ä¸ºäº†æ›´æ–¹ä¾¿è¿›è¡Œé‰´æƒæ“ä½œã€‚**
`@ComponentScan(basePackages = "com.deye.ems.cloud.common.map.api")`ç»„ä»¶æ‰«æã€‚ä¸‹é¢æ˜¯åŒ…ä¸­çš„ä¸€ä¸ª`interface`ã€‚

```java
package com.deye.ems.cloud.common.map.api;

import com.deye.ems.cloud.common.map.config.GaodeApiConfiguration;
import com.deye.ems.cloud.common.map.model.response.GeocodeResponse;
import com.deye.ems.cloud.common.map.model.response.RegeocodeResponse;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

/**
 * åœ°ç†/é€†åœ°ç†ç¼–ç 
 * <br>
 * åœ°ç†ç¼–ç /é€†åœ°ç†ç¼–ç  API æ˜¯é€šè¿‡ HTTP/HTTPS åè®®è®¿é—®è¿œç¨‹æœåŠ¡çš„æ¥å£ï¼Œæä¾›ç»“æ„åŒ–åœ°å€ä¸ç»çº¬åº¦ä¹‹é—´çš„ç›¸äº’è½¬åŒ–çš„èƒ½åŠ›ã€‚
 * <br>
 * https://lbs.amap.com/api/webservice/guide/api/georegeo#geo
 */
@FeignClient(name = "gaode-geocode-service", configuration = {GaodeApiConfiguration.class}, url = "${map.gaode.url}", path = "/v3/geocode")
public interface GeocodeApi {
    /**
     * åœ°ç†ç¼–ç 
     * @param address ç»“æ„åŒ–åœ°å€ä¿¡æ¯<br>
     *                è§„åˆ™éµå¾ªï¼šå›½å®¶ã€çœä»½ã€åŸå¸‚ã€åŒºå¿ã€åŸé•‡ã€ä¹¡æ‘ã€è¡—é“ã€é—¨ç‰Œå·ç ã€å±‹é‚¨ã€å¤§å¦ï¼Œå¦‚ï¼šåŒ—äº¬å¸‚æœé˜³åŒºé˜œé€šä¸œå¤§è¡—6å·ã€‚
     * @param city æŒ‡å®šæŸ¥è¯¢çš„åŸå¸‚<br>
     *             å¯é€‰è¾“å…¥å†…å®¹åŒ…æ‹¬ï¼šæŒ‡å®šåŸå¸‚çš„ä¸­æ–‡ï¼ˆå¦‚åŒ—äº¬ï¼‰ã€æŒ‡å®šåŸå¸‚çš„ä¸­æ–‡å…¨æ‹¼ï¼ˆbeijingï¼‰ã€citycodeï¼ˆ010ï¼‰ã€adcodeï¼ˆ110000ï¼‰ï¼Œä¸æ”¯æŒå¿çº§å¸‚ã€‚å½“æŒ‡å®šåŸå¸‚æŸ¥è¯¢å†…å®¹ä¸ºç©ºæ—¶ï¼Œä¼šè¿›è¡Œå…¨å›½èŒƒå›´å†…çš„åœ°å€è½¬æ¢æ£€ç´¢ã€‚
     * @return
     */
    @GetMapping("/geo")
    GeocodeResponse geocode(
            @RequestParam("address") String address,
            @RequestParam(value = "city", required = false) String city);

    /**
     * é€†åœ°ç†ç¼–ç 
     * @param location ç»çº¬åº¦åæ ‡<br>
     *                 ä¼ å…¥å†…å®¹è§„åˆ™ï¼šç»åº¦åœ¨å‰ï¼Œçº¬åº¦åœ¨åï¼Œç»çº¬åº¦é—´ä»¥â€œ,â€åˆ†å‰²ï¼Œç»çº¬åº¦å°æ•°ç‚¹åä¸è¦è¶…è¿‡ 6 ä½ã€‚
     * @return
     */
    @GetMapping("/regeo")
    RegeocodeResponse regeocode(@RequestParam("location") String location);
}

```

`@FeignClient(name = "gaode-geocode-service", configuration = {GaodeApiConfiguration.class}, url = "${map.gaode.url}", path = "/v3/geocode")`æ³¨è§£

1. `name`å±æ€§ç”¨äºæŒ‡å®šè¦è°ƒç”¨çš„å¾®æœåŠ¡åç§°ï¼Œåé¢å‡ºç°`url`å±æ€§åˆ™ä½¿ç”¨`url`
2. `configuration`å±æ€§ç”¨äºæŒ‡å®š`Feign`å®¢æˆ·ç«¯çš„é…ç½®ç±»ï¼Œè§„å®š`Feign`çš„è¡Œä¸º

```java
package com.deye.ems.cloud.common.map.config;

import org.springframework.context.annotation.Bean;

public class GaodeApiConfiguration {
    @Bean
    public GaodeApiRequestInterceptor gaodeApiRequestInterceptor(GaodeMapProperties gaodeMapProperties) {
        return new GaodeApiRequestInterceptor(gaodeMapProperties);
    }
}

```

é…ç½®ç±»ä¸­è¿”å›äº†ä¸€ä¸ª beanï¼Œbean çš„ç±»å£°æ˜å¦‚ä¸‹ï¼š

```java
package com.deye.ems.cloud.common.map.config;

import com.deye.ems.cloud.common.map.util.GaodeSignatureUtil;
import feign.RequestInterceptor;
import feign.RequestTemplate;
import lombok.Data;
import lombok.SneakyThrows;
import lombok.extern.slf4j.Slf4j;


@Data
@Slf4j
public class GaodeApiRequestInterceptor implements RequestInterceptor {
    private GaodeMapProperties gaodeMapProperties;

    public GaodeApiRequestInterceptor() {
    }

    public GaodeApiRequestInterceptor(GaodeMapProperties gaodeMapProperties) {
        this.gaodeMapProperties = gaodeMapProperties;
    }

    @SneakyThrows
    @Override
    public void apply(RequestTemplate requestTemplate) {
        // å‘æ¯ä¸ªè¯·æ±‚æ·»åŠ key
        requestTemplate.query("key", gaodeMapProperties.getKey());
        // å‘è¯·æ±‚æ·»åŠ ç­¾å
//        requestTemplate.query("sig", GaodeSignatureUtil.getSignature(requestTemplate.queries(), gaodeMapProperties.getSecret()));
    }
}

```

`GaodeApiRequestInterceptor`æ˜¯ä¸€ä¸ªè¯·æ±‚çš„æ‹¦æˆªå™¨ï¼Œ`apply`å¯ä»¥æ‹¦æˆª`Feign`å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚å¹¶æ·»åŠ é¢å¤–å¤„ç†ï¼Œä¸Šè¿°ä¾¿å°† key å’Œ ç­¾ååŠ å…¥è¯·æ±‚å‚æ•°ã€‚ç±»ä¼¼çš„ï¼Œheader é‰´æƒä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šè¿°æ–¹å¼å®ç°ã€‚
ç”Ÿæˆç­¾åçš„å·¥å…·ç±»å¦‚ä¸‹ï¼š

```java
package com.deye.ems.cloud.common.map.util;

import cn.hutool.crypto.digest.DigestUtil;
import lombok.SneakyThrows;
import org.apache.commons.codec.net.URLCodec;

import java.util.Collection;
import java.util.Map;

/**
 * ç”Ÿæˆç­¾åçš„å·¥å…·ç±»
 */
public class GaodeSignatureUtil {
    /**
     * è·å–è¯·æ±‚çš„ç­¾å
     * @param parameters è¯·æ±‚å‚æ•°
     * @param secret ç§é’¥
     * @return
     */
    @SneakyThrows
    public static String getSignature(Map<String, Collection<String>> parameters, String secret){
        // è·å–è¯·æ±‚å‚æ•°å­—ç¬¦ä¸²ï¼ˆURL è§£ç ä¹‹åçš„ï¼‰
        String queryParameters = getQueryParameters(parameters);
        // ç”Ÿæˆ MD5 æ¶ˆæ¯æ‘˜è¦
        return getMD5Digest(queryParameters, secret);
    }

    /**
     * è·å–è¯·æ±‚å‚æ•°å­—ç¬¦ä¸²
     * @param parameters
     * @return
     */
    @SneakyThrows
    private static String getQueryParameters(Map<String, Collection<String>> parameters) {
        // åˆ›å»ºä¸€ä¸ªStringBuilderç”¨äºæ„å»ºå‚æ•°å­—ç¬¦ä¸²
        StringBuilder paramStringBuilder = new StringBuilder();
        // éå†å‚æ•°æ˜ å°„ï¼Œå°†å‚æ•°åå’Œå€¼æ‹¼æ¥æˆå­—ç¬¦ä¸²
        parameters.keySet().stream()
                .sorted() // æŒ‰å­—ç¬¦ä¸²å­—æ¯é¡ºåºæ’åº
                .forEach(key -> parameters.get(key).stream().forEach(value -> paramStringBuilder.append(key).append("=").append(value).append("&")));
        // å»é™¤æœ«å°¾çš„"&"å­—ç¬¦
        String paramString = paramStringBuilder.toString();
        if (paramString.endsWith("&")) {
            paramString = paramString.substring(0, paramString.length() - 1);
        }
        // è¿›è¡Œ URL è§£ç 
        URLCodec urlCodec = new URLCodec();
        return urlCodec.decode(paramString);
    }

    /**
     * è®¡ç®— MD5 æ¶ˆæ¯æ‘˜è¦
     * @param paramString è§£ç åçš„è¯·æ±‚å‚æ•°å­—ç¬¦ä¸²
     * @param secret ç§é’¥
     * @return
     */
    private static String getMD5Digest(String paramString, String secret) {
        return DigestUtil.md5Hex(paramString + secret);
    }
}

```
